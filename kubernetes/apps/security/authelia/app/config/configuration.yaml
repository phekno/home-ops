---
theme: auto
server:
  address: 'tcp://0.0.0.0:9091'
  buffers:
    read: 8192
    write: 8192
  timeouts:
    read: 6s
    write: 6s
    idle: 30s
  endpoints:
    authz:
      ext-authz:
        implementation: ExtAuthz
log:
  level: debug
telemetry:
  metrics:
    enabled: true
    address: 'tcp://0.0.0.0:9959'
    buffers:
      read: 4096
      write: 4096
identity_validation:
  reset_password:
    jwt_secret: "{{ .AUTHELIA_JWT_SECRET }}"
totp:
  disable: false
webauthn:
  disable: false
  enable_passkey_login: true
  display_name: Phekno Authelia
duo_api:
  disable: true
authentication_backend:
  password_reset:
    disable: false
  refresh_interval: 5m
  ldap:
    implementation: lldap
    address: 'ldap://lldap.security.svc.cluster.local:389'
    timeout: 5s
    start_tls: false
    base_dn: 'dc=phekno,dc=io'
    username_attribute: uid
    additional_users_dn: 'ou=people'
    users_filter: '(&({username_attribute}={input})(objectClass=person))'
    additional_groups_dn: 'ou=groups'
    groups_filter: '(member={dn})'
    group_name_attribute: cn
    mail_attribute: mail
    display_name_attribute: displayName
    user: 'uid=admin,ou=people,dc=phekno,dc=io'
    password: "{{ .AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD }}"
session:
  name: authelia_session
  secret: "{{ .AUTHELIA_SESSION_SECRET }}"
  expiration: 1h
  inactivity: 15m
  remember_me: 1M
  cookies:
    - domain: phekno.io
      authelia_url: https://auth.phekno.io
      default_redirection_url: https://phekno.io
  redis:
    host: dragonfly.db.svc.cluster.local
    port: 6379
regulation:
  max_retries: 3
  find_time: 2m
  ban_time: 5m
storage:
  encryption_key: "{{ .AUTHELIA_STORAGE_ENCRYPTION_KEY }}"
  postgres:
    address: 'postgres-rw.db.svc.cluster.local:5432'
    database: authelia
    username: "{{ .AUTHELIA_POSTGRES_USERNAME }}"
    password: "{{ .AUTHELIA_POSTGRES_PASSWORD }}"
notifier:
  disable_startup_check: false
  smtp:
    address: submission://email-smtp.us-east-1.amazonaws.com:587
    username: "{{ .AUTHELIA_NOTIFIER_SMTP_USERNAME }}"
    password: "{{ .AUTHELIA_NOTIFIER_SMTP_PASSWORD }}"
    sender: Authelia Admin <admin@phekno.io>
access_control:
  default_policy: deny
  rules:
    # Bypass all Authelia portal paths
    - domain:
        - 'auth.phekno.io'
      policy: bypass
    # Admin services requiring 2FA
    - domain:
        - 'grafana.phekno.io'
        - 'prometheus.phekno.io'
        - 'alertmanager.phekno.io'
        - 'longhorn.phekno.io'
      policy: two_factor
      subject:
        - 'group:admins'
    # Catch-all for authenticated internal services
    - domain:
        - '*.phekno.io'
      policy: one_factor
identity_providers:
  oidc:
    hmac_secret: "{{ .AUTHELIA_OIDC_HMAC_SECRET }}"
    jwks:
      - key_id: 'authelia'
        algorithm: 'RS256'
        use: 'sig'
        key:
          path: /secrets/jwks/jwks.pem
    claims_policies:
      grafana:
        id_token:
          - 'groups'
          - 'email'
          - 'name'
          - 'preferred_username'
    clients:
      - client_id: 'grafana'
        client_name: 'Grafana'
        client_secret: "{{ .AUTHELIA_OIDC_GRAFANA_CLIENT_SECRET_HASH }}"
        public: false
        authorization_policy: 'two_factor'
        require_pkce: true
        pkce_challenge_method: 'S256'
        redirect_uris:
          - 'https://grafana.phekno.io/login/generic_oauth'
        scopes:
          - 'openid'
          - 'profile'
          - 'groups'
          - 'email'
        claims_policy: 'grafana'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        token_endpoint_auth_method: 'client_secret_basic'
